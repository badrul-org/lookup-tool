{% extends "base.html" %}

{% block title %}Create Customer & Work Order - Sterling Septic & Plumbing LLC{% endblock %}

{% block content %}
<div class="{% if request.args.get('embed') %}container-fluid px-0 py-3 cc-embed{% else %}container py-4{% endif %}">
    {% if not request.args.get('embed') %}
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0"><i class="fas fa-user-plus me-2"></i>Create Customer & Work Order</h1>
        <div class="d-flex gap-2">
            {% if request.args.get('session_id') %}
            <a href="{{ url_for('results') }}?session_id={{ request.args.get('session_id') }}"
                class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Back to Results
            </a>
            {% else %}
            <a href="{{ url_for('lookup_tool') }}" class="btn btn-outline-secondary">
                <i class="fas fa-search me-1"></i> Back to Lookup
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <div class="card">
        <div class="card-body">
            <form id="combined-form" class="row g-3" onsubmit="return false;">
                <input type="hidden" id="cc-session-id" value="{{ request.args.get('session_id', '') }}" />
                <input type="hidden" id="cc-work-order-id" value="" />

                <!-- Customer Section -->
                <div class="col-12">
                    <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-user me-2"></i>Customer Details</h5>
                </div>

                <div class="col-md-4">
                    <label class="form-label">First Name</label>
                    <input type="text" class="form-control" id="cc-first-name" placeholder="Type here" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Last Name</label>
                    <input type="text" class="form-control" id="cc-last-name" placeholder="Type here" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Company Name</label>
                    <input type="text" class="form-control" id="cc-company-name" placeholder="Type here" />
                </div>

                <div class="col-md-6">
                    <label class="form-label">Display Name <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="cc-display-name" placeholder="Type here" />
                    <div class="invalid-feedback">Display Name is required.</div>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Parent</label>
                    <input type="text" class="form-control" id="cc-parent" placeholder="Type here" />
                </div>

                <div class="col-md-3">
                    <label class="form-label">Customer Type</label>
                    <select class="form-select" id="cc-customer-type">
                        <option value="Residential">Residential</option>
                        <option value="Commercial">Commercial</option>
                        <option value="Existing Customer">Existing Customer</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Customer Since</label>
                    <input type="text" class="form-control" id="cc-customer-since" placeholder="Type here" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Lead Source</label>
                    <select class="form-select" id="cc-lead-source">
                        <option value="">Select</option>
                        <option>Existing Customer</option>
                        <option>Google</option>
                        <option>Sterling Septic -FE</option>
                        <option>Thryv</option>
                        <option>Yelp</option>
                        <option>Referral</option>
                    </select>
                </div>


                <div class="col-12">
                    <label class="form-label">Pinned Note</label>
                    <textarea class="form-control" id="cc-note" rows="2" placeholder="Type here"></textarea>
                </div>

                <div class="col-12 mt-4"><strong>Physical Location Details</strong></div>

                <div class="col-md-8">
                    <label class="form-label">Address 1</label>
                    <input type="text" class="form-control" id="cc-addr1" placeholder="Type here"
                        value="{{ session_data.address if session_data else '' }}" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Address 2</label>
                    <input type="text" class="form-control" id="cc-addr2" placeholder="Type here" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">City</label>
                    <input type="text" class="form-control" id="cc-city" placeholder="Type here"
                        value="{{ session_data.city if session_data else '' }}" />
                </div>
                <div class="col-md-2">
                    <label class="form-label">State</label>
                    <input type="text" class="form-control" id="cc-state" value="WA" placeholder="Type here" />
                </div>
                <div class="col-md-2">
                    <label class="form-label">ZIP</label>
                    <input type="text" class="form-control" id="cc-zip" placeholder="Type here"
                        value="{{ session_data.zip_code if session_data else '' }}" />
                </div>
                <div class="col-md-2">
                    <label class="form-label">County</label>
                    <input type="text" class="form-control" id="cc-county" placeholder="Type here"
                        value="{{ session_data.county if session_data else '' }}" />
                </div>

                <div class="col-12">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="cc-billing-same" checked />
                        <label class="form-check-label" for="cc-billing-same">Billing same as physical</label>
                    </div>
                </div>

                <div id="cc-billing-fields" class="row g-3">
                    <div class="col-md-8">
                        <label class="form-label">Billing Address 1</label>
                        <input type="text" class="form-control" id="cc-bill-addr1" placeholder="Type here" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Billing Address 2</label>
                        <input type="text" class="form-control" id="cc-bill-addr2" placeholder="Type here" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Billing City</label>
                        <input type="text" class="form-control" id="cc-bill-city" placeholder="Type here" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Billing State</label>
                        <input type="text" class="form-control" id="cc-bill-state" value="WA" placeholder="Type here" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Billing ZIP</label>
                        <input type="text" class="form-control" id="cc-bill-zip" placeholder="Type here" />
                    </div>
                </div>

                <div class="col-12 mt-4"><strong>Contacts</strong></div>

                <div class="col-md-6">
                    <label class="form-label">Contact Name</label>
                    <input type="text" class="form-control" id="cc-contact-name" placeholder="Type here" />
                    <div class="invalid-feedback">Contact name must be exactly two words.</div>
                </div>
                <div class="col-12">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="cc-contact-email" />
                        <label class="form-check-label" for="cc-contact-email">Email</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="cc-contact-sms" checked />
                        <label class="form-check-label" for="cc-contact-sms">SMS</label>
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Phone Label</label>
                    <input type="text" class="form-control" id="cc-phone-label" value="Phone" placeholder="Type here" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Phone Number</label>
                    <input type="text" class="form-control" id="cc-phone-number" placeholder="Type here" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Email Label</label>
                    <input type="text" class="form-control" id="cc-email-label" value="Email" placeholder="Type here" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" id="cc-email" placeholder="Type here" />
                    <div class="invalid-feedback">Please enter a valid email address.</div>
                </div>

                <div class="col-12 mt-4"><strong>Business Profile</strong></div>
                <div class="col-md-4">
                    <label class="form-label">Terms <span class="text-danger">*</span></label>
                    <select class="form-select" id="cc-terms">
                        <option>Due On Reciept</option>
                        <option>Escrow Billing</option>
                        <option>Net 10</option>
                        <option>Net 10th</option>
                        <option>Net 15</option>
                        <option>Net 30</option>
                        <option>Net 60</option>
                        <option>Payment Plan</option>
                    </select>
                    <div class="invalid-feedback">Terms is required.</div>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Tax Code <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="cc-tax-code" placeholder="Type here"
                        value="{{ session_data.location_code if session_data else '' }}" />
                    <div class="invalid-feedback">Tax Code is required.</div>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Sales Rep</label>
                    <select class="form-select" id="cc-sales-rep-bottom">
                        <option value="">Select</option>
                        <option>01- Mackie</option>
                        <option>02 - Huss</option>
                        <option>03- Russell</option>
                        <option>04 - Ahkeem</option>
                        <option>05 - Danny</option>
                        <option>06 - Cris</option>
                        <option>07 - Gene</option>
                        <option>08 - Cameron</option>
                        <option>09- Eric</option>
                        <option>10 - Damon</option>
                        <option>11 - Andrea</option>
                        <option>Ahmed T.</option>
                        <option>Cameron P.</option>
                        <option>Mary- TAX/ACT</option>
                        <option>Z- F.E ADMIN.</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Require PO</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="cc-require-po" />
                        <label class="form-check-label" for="cc-require-po">Yes</label>
                    </div>
                </div>

                <!-- Work Order Section -->
                <div class="col-12 mt-5">
                    <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-file-alt me-2"></i>Work Order Details</h5>
                </div>

                <div class="col-md-6">
                    <label class="form-label">Immediate Action</label>
                    <select id="wo-immediate" class="form-select">
                        <option>Create Work Order</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Task <span class="text-danger">*</span></label>
                    <select id="wo-task" class="form-select" required>
                        <option value="" selected>Select</option>
                        <option>HOME SALE</option>
                        <option>HOME SALE REPAIR</option>
                        <option>PUMPING</option>
                        <option>ROUTINE INSPECTION</option>
                        <option>SERVICE CALL / TROUBLESHOOT</option>
                        <option>SERVICE TRUCK - 1/2 DAY</option>
                        <option>SERVICE TRUCK - 1/4 DAY</option>
                        <option>SERVICE TRUCK - FULL DAY</option>
                    </select>
                    <div class="invalid-feedback">Task is required.</div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Task Duration</label>
                    <input type="text" id="wo-duration" class="form-control" value="0" placeholder="1:00" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Priority</label>
                    <select id="wo-priority" class="form-select">
                        <option value="" selected>Select</option>
                        <option value="ADVANCED SVC" style="background-color: #ffcccc;">ADVANCED SVC</option>
                        <option value="ADVANCED SVC - EMERGENCY" style="background-color: #ff0000; color: white;">
                            ADVANCED SVC - EMERGENCY</option>
                        <option value="CLERICAL" style="background-color: #e6e6e6;">CLERICAL</option>
                        <option value="EXCAVATOR" style="background-color: #ffffcc;">EXCAVATOR</option>
                        <option value="HOMESALE" style="background-color: #ccffcc;">HOMESALE</option>
                        <option value="PREP / RETURN" style="background-color: #e6e6e6;">PREP / RETURN</option>
                        <option value="PUMPING" style="background-color: #ccffff;">PUMPING</option>
                        <option value="PUMPING - ASSIST" style="background-color: #ccffff;">PUMPING - ASSIST</option>
                        <option value="PUMPING - EMERGENCY" style="background-color: #ff0000; color: white;">PUMPING -
                            EMERGENCY</option>
                        <option value="SVC TRUCK" style="background-color: #ccccff;">SVC TRUCK</option>
                        <option value="SVC TRUCK - ASSIST" style="background-color: #ccccff;">SVC TRUCK - ASSIST
                        </option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Lead Source <span class="text-danger">*</span></label>
                    <select id="wo-lead-source" class="form-select" required>
                        <option value="" selected>Select</option>
                        <option>Existing Customer</option>
                        <option>Google</option>
                        <option>Sterling Septic -FE</option>
                        <option>Thryv</option>
                        <option>Yelp</option>
                    </select>
                    <div class="invalid-feedback">Lead source is required.</div>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Primary Tech</label>
                    <input type="text" id="wo-primary-tech" class="form-control" placeholder="Type here" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Start Date</label>
                    <input type="text" id="wo-start-date" class="form-control" placeholder="MM/DD/YYYY" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Start Time</label>
                    <input type="text" id="wo-start-time" class="form-control" placeholder="0:00" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Customer PO</label>
                    <input type="text" id="wo-customer-po" class="form-control" placeholder="Type Here" />
                </div>
                <div class="col-12">
                    <label class="form-label">Work Order Description</label>
                    <textarea id="wo-description" class="form-control" rows="3" placeholder="Type Here"></textarea>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Tags</label>
                    <input type="text" id="wo-tags" class="form-control" placeholder="Type here" />
                </div>

                <div class="col-12 d-flex justify-content-end gap-2 mt-4 mb-5">
                    <button type="button" class="btn btn-secondary" onclick="window.history.back()"><i
                            class="fas fa-times me-1"></i>Cancel</button>
                    <button type="button" class="btn btn-success" id="combined-submit-btn"><i
                            class="fas fa-check me-1"></i>Add Customer + Work Order</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    (() => {
        function getSessionId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('session_id') || document.getElementById('cc-session-id')?.value || '';
        }

        function prefillFromQuery() {
            try {
                const params = new URLSearchParams(window.location.search);
                const setVal = (id, val) => { const el = document.getElementById(id); if (el && val) el.value = val; };
                setVal('cc-addr1', params.get('address'));
                setVal('cc-city', params.get('city'));
                setVal('cc-zip', params.get('zip'));
                setVal('cc-county', params.get('county'));
                setVal('cc-tax-code', params.get('location_code'));
            } catch (_) { }
            try {
                const today = new Date();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                const yyyy = today.getFullYear();
                const since = document.getElementById('cc-customer-since');
                if (since && !since.value) since.value = `${mm}/${dd}/${yyyy}`;
            } catch (_) { }
        }

        async function createCombined() {
            const val = (id) => (document.getElementById(id)?.value || '').trim();
            const bool = (id) => !!document.getElementById(id)?.checked;

            // Customer Payload
            const customerPayload = {
                firstName: val('cc-first-name'),
                lastName: val('cc-last-name'),
                companyName: val('cc-company-name'),
                displayName: val('cc-display-name'),
                parent: val('cc-parent'),
                customerType: val('cc-customer-type'),
                customerSince: val('cc-customer-since'),
                leadSource: val('cc-lead-source'),
                note: val('cc-note'),
                address1: val('cc-addr1'),
                address2: val('cc-addr2'),
                city: val('cc-city'),
                state: val('cc-state'),
                zip: val('cc-zip'),
                county: val('cc-county'),
                billingSame: bool('cc-billing-same'),
                billFromOffice: false,
                billAddress1: val('cc-bill-addr1'),
                billAddress2: val('cc-bill-addr2'),
                billCity: val('cc-bill-city'),
                billState: val('cc-bill-state'),
                billZip: val('cc-bill-zip'),
                contactName: val('cc-contact-name'),
                phone_checkbox: bool('cc-contact-phone'),
                email_checkbox: bool('cc-contact-email'),
                sms_checkbox: bool('cc-contact-sms'),
                phoneLabel: val('cc-phone-label'),
                phoneNumber: val('cc-phone-number'),
                emailLabel: val('cc-email-label'),
                email: val('cc-email'),
                terms: val('cc-terms'),
                taxCode: val('cc-tax-code'),
                salesRep: val('cc-sales-rep') || val('cc-sales-rep-bottom'),
                requirePO: bool('cc-require-po'),
                session_id: getSessionId()
            };

            // Work Order Payload
            const workOrderPayload = {
                immediate: val('wo-immediate'),
                task: val('wo-task'),
                task_duration: val('wo-duration'),
                priority: val('wo-priority'),
                lead_source: val('wo-lead-source'),
                primary_tech: val('wo-primary-tech'),
                start_date: val('wo-start-date'),
                start_time: val('wo-start-time'),
                customer_po: val('wo-customer-po'),
                description: val('wo-description'),
                tags: val('wo-tags'),
                session_id: getSessionId()
            };

            // Validation
            const missing = [];
            const setInvalid = (id, invalid) => {
                const el = document.getElementById(id);
                if (!el) return;
                if (invalid) el.classList.add('is-invalid'); else el.classList.remove('is-invalid');
            };

            // Customer Validation
            if (!customerPayload.terms) { missing.push('Terms'); setInvalid('cc-terms', true); } else setInvalid('cc-terms', false);
            if (!customerPayload.taxCode) { missing.push('Tax Code'); setInvalid('cc-tax-code', true); } else setInvalid('cc-tax-code', false);
            if (!customerPayload.displayName) { missing.push('Display Name'); setInvalid('cc-display-name', true); } else setInvalid('cc-display-name', false);

            // Work Order Validation
            if (!workOrderPayload.task) { missing.push('Task'); setInvalid('wo-task', true); } else setInvalid('wo-task', false);
            if (!workOrderPayload.lead_source) { missing.push('Lead Source (WO)'); setInvalid('wo-lead-source', true); } else setInvalid('wo-lead-source', false);

            // Contact Name (Full Name) must be exactly two words
            const fullNameWords = (customerPayload.contactName || '').split(/\s+/).filter(Boolean);
            if (fullNameWords.length !== 2) {
                missing.push('Contact Name (two words)');
                setInvalid('cc-contact-name', true);
            } else {
                setInvalid('cc-contact-name', false);
            }

            if (missing.length) {
                alert('Please provide: ' + Array.from(new Set(missing)).join(', '));
                return;
            }

            const btn = document.getElementById('combined-submit-btn');
            const oldHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';

            try {
                // Notify parent we are starting
                try { window.parent && window.parent.postMessage({ type: 'combined-create-status', phase: 'start' }, '*'); } catch (_) { }

                const res = await fetch('/api/create-customer-workorder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customer: customerPayload, work_order: workOrderPayload })
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) throw new Error((data && data.error) || 'Failed to process request');

                // Notify parent of success
                try { window.parent && window.parent.postMessage({ type: 'combined-create-status', phase: 'done', text: 'Customer & Work Order Created, Documents Uploaded', data: data }, '*'); } catch (_) { }

                // Redirect back to results or show success message
                // For now, let's just alert and maybe reload or go back
                // alert('Success! Customer and Work Order created.');
                // window.history.back();

            } catch (e) {
                try { window.parent && window.parent.postMessage({ type: 'combined-create-status', phase: 'error', error: e.message }, '*'); } catch (_) { }
                alert('Error: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = oldHtml;
            }
        }

        function toggleBilling() {
            const same = document.getElementById('cc-billing-same').checked;
            document.getElementById('cc-billing-fields').style.display = same ? 'none' : '';
        }

        function initPage() {
            try {
                prefillFromQuery();
                const billingSame = document.getElementById('cc-billing-same');
                if (billingSame) billingSame.addEventListener('change', toggleBilling);
                toggleBilling();

                const first = document.getElementById('cc-first-name');
                const last = document.getElementById('cc-last-name');
                const disp = document.getElementById('cc-display-name');
                let edited = false;
                if (disp) disp.addEventListener('input', () => { edited = (disp.value || '').trim().length > 0; });
                function sync() {
                    if (edited || !disp) return;
                    const v = [first?.value?.trim() || '', last?.value?.trim() || ''].filter(Boolean).join(' ');
                    disp.value = v;
                }
                if (first) first.addEventListener('input', sync);
                if (last) last.addEventListener('input', sync);

                // Priority Color Logic
                const prioritySelect = document.getElementById('wo-priority');
                if (prioritySelect) {
                    prioritySelect.addEventListener('change', function () {
                        const selectedOption = this.options[this.selectedIndex];
                        this.style.backgroundColor = selectedOption.style.backgroundColor;
                        this.style.color = selectedOption.style.color;
                    });
                    // Trigger once to set initial color if value exists
                    if (prioritySelect.value) {
                        prioritySelect.dispatchEvent(new Event('change'));
                    }
                }

                // Auto-fill Task Duration
                const taskSelect = document.getElementById('wo-task');
                if (taskSelect) {
                    taskSelect.addEventListener('change', function () {
                        const val = (this.value || '').trim().toUpperCase();
                        const oneHourTasks = new Set([
                            'HOME SALE', 'HOME SALE REPAIR', 'PUMPING',
                            'ROUTINE INSPECTION', 'SERVICE CALL / TROUBLESHOOT'
                        ]);
                        const durationMap = new Map([
                            ['SERVICE TRUCK - 1/2 DAY', '4:00'],
                            ['SERVICE TRUCK - 1/4 DAY', '2:00'],
                            ['SERVICE TRUCK - FULL DAY', '8:00']
                        ]);
                        const dur = document.getElementById('wo-duration');
                        if (!dur) return;
                        if (durationMap.has(val)) {
                            dur.value = durationMap.get(val);
                        } else if (oneHourTasks.has(val)) {
                            dur.value = '1:00';
                        }
                    });
                }

                const btn = document.getElementById('combined-submit-btn');
                if (btn && !btn.dataset.wired) {
                    btn.addEventListener('click', createCombined);
                    btn.dataset.wired = '1';
                }
            } catch (e) { /* no-op */ }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initPage);
        } else {
            initPage();
        }
    })();
</script>
{% endblock %}