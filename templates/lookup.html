{% extends "base.html" %}

{% block title %}Lookup Tool - Sterling Septic & Plumbing LLC{% endblock %}

{% block content %}
<div class="lookup-container">
    <div class="row justify-content-center">
        <div class="col-12 text-center mb-5">
            <h1 class="lookup-title">
                <i class="fas fa-search me-3"></i>
                Document Lookup Tool
            </h1>
            <p class="lookup-subtitle">Enter property details to start your lookup</p>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-12 col-md-10 col-lg-8 col-xl-6">
            <div class="lookup-card">
                <div class="lookup-card-header">
                    <h5 class="lookup-card-title">
                        <i class="fas fa-map-marker-alt me-2"></i>
                        Property Information
                    </h5>
                </div>
                <div class="lookup-card-body">
                    <form id="lookup-form" class="lookup-form">
                        <div class="mb-4">
                            <label for="county" class="lookup-label">County *</label>
                            <select class="lookup-select" id="county" name="county" required>
                                <option value="">Select County</option>
                                <option value="King">King County</option>
                                <option value="Pierce" selected>Pierce County</option>
                                <!-- <option value="Snohomish">Snohomish County</option>
                                <option value="Kitsap">Kitsap County</option>
                                <option value="Thurston">Thurston County</option> -->
                            </select>
                        </div>

                        <div class="mb-4">
                            <label for="address" class="lookup-label">Address Line 1 *</label>
                            <input type="text" class="lookup-input" id="address" name="address_line_1" required
                                placeholder="Enter address (e.g., 123 Main St, Tacoma, WA 98401)">
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <label for="city" class="lookup-label">City</label>
                                <input type="text" class="lookup-input" id="city" name="city"
                                    placeholder="Enter city name">
                            </div>
                            <div class="col-md-6 mb-4">
                                <label for="zip" class="lookup-label">ZIP Code</label>
                                <input type="text" class="lookup-input" id="zip" name="zip_code"
                                    placeholder="Enter ZIP code">
                            </div>
                        </div>

                        <div class="lookup-submit-container">
                            <button type="submit" class="lookup-submit-btn" id="submit-btn">
                                <i class="fas fa-search me-2"></i>
                                Start Lookup
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    let isSubmitting = false; // Flag to prevent double submission

    document.getElementById('lookup-form').addEventListener('submit', function (e) {
        e.preventDefault();
        startLookup();
    });

    // Also add click event listener to the button for extra protection
    document.getElementById('submit-btn').addEventListener('click', function (e) {
        e.preventDefault();
        startLookup();
    });

    function startLookup() {
        // Prevent double submission
        if (isSubmitting) {
            console.log('Lookup already in progress, ignoring duplicate submission');
            return;
        }

        const formData = new FormData(document.getElementById('lookup-form'));
        const data = Object.fromEntries(formData);

        // Validate required fields
        if (!data.address_line_1 || !data.county) {
            alert('Please fill in all required fields.');
            return;
        }

        // Set submitting flag
        isSubmitting = true;

        // Disable form and button
        document.getElementById('submit-btn').disabled = true;
        document.getElementById('submit-btn').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Starting...';

        // Disable all form inputs
        const formInputs = document.querySelectorAll('#lookup-form input, #lookup-form select');
        formInputs.forEach(input => input.disabled = true);

        // Start lookup
        fetch('/api/lookup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    throw new Error(result.error);
                }

                // Immediately redirect to results page
                window.location.href = result.redirect_url;
            })
            .catch(error => {
                console.error('Error starting lookup:', error);
                alert('Error starting lookup: ' + error.message);
                resetForm();
            });
    }

    function resetForm() {
        // Reset submitting flag
        isSubmitting = false;

        // Re-enable form and button
        document.getElementById('submit-btn').disabled = false;
        document.getElementById('submit-btn').innerHTML = '<i class="fas fa-search me-2"></i>Start Lookup';

        // Re-enable all form inputs
        const formInputs = document.querySelectorAll('#lookup-form input, #lookup-form select');
        formInputs.forEach(input => input.disabled = false);
    }
</script>
{% endblock %}